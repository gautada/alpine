#!/bin/sh
#
# container-backup
#
# Controller script for container wide back-up

# Must have a defined file function
FILE_FUNCTION="/etc/container/backup.fnc"
if [ ! -f $FILE_FUNCTION ] ; then
 echo "[ INFO] Function file($FILE_FUNCTION) does not exist"
 return 1
else
 source $FILE_FUNCTION
fi

# Load the encryption key
ENCRYPTION_KEY="/etc/container/keys/backup.key"
KEY_FINGERPRINT="$(gpg --show-keys $ENCRYPTION_KEY | sed -n '2p' | xargs)"
if [ "" == "$(gpg --list-keys)" ] ; then
 gpg --trusted-key $KEY_FINGERPRINT --import $ENCRYPTION_KEY
else
 gpg --list-keys
fi
 # gpg --trusted-key $(gpg --show-keys /etc/backup/config/encryption.key | sed -n '2p' | xargs) --import /etc/backup/config/encryption.key
 
# Execute backup
BACKUP_TAG="$(date +%H)"
FOLDER_WORKING="/tmp/backup"
FOLDER_CACHE="/var/backup"
FOLDER_BACKUP="/opt/backup"

echo "[ INFO]: Execute the container backup function"
cd $FOLDER_WORKING
container_backup
if [ ! $? -eq 0 ] ; then
 echo "[ERROR]: Function did not work"
 return 1
fi
rm -rvf $FOLDER_WORKING/*
cd /

# Clear all but the latest chain
echo "[ INFO]: Clean up backups"
duplicity remove-all-but-n-full 1 --force file://$FOLDER_BACKUP

FILE_MANIFEST=$FOLDER_BACKUP/duplicity-full.*.manifest.gpg
# SET BACKUP CHAIN
if [ ! -f $FILE_MANIFEST ] ; then
 echo "[ INFO]: FULL backup(File)"
 
 duplicity full --encrypt-key $KEY_FINGERPRINT --archive-dir $FOLDER_CACHE $FOLDER_WORKING file://$FOLDER_BACKUP
else
   # RESET BACKUP CHAIN - At midnight
 if [ "00" == "$(date +%H)" ] ; then
  echo "[ INFO]: FULL backup(00)"
  duplicity full --encrypt-key $KEY_FINGERPRINT --archive-dir $FOLDER_CACHE $FOLDER_WORKING file://$FOLDER_BACKUP
 else
  TIMESTAMP_LAST=$(date +%s -r $FILE_MANIFEST)
  TIMESTAMP_NOW=$(date +%s)
  TIMESTAMP_DAY=86400
  TIMESTAMP_DELTA=$(($TIMESTAMP_NOW-$TIMESTAMP_LAST))
  # RESET BACKUP CHAIN - If older than 24 hours
  if [ $TIMESTAMP_DAY -lt $TIMESTAMP_DELTA ] ; then
   echo "[ INFO]: FULL backup(Timestamp)"
   duplicity full --encrypt-key $KEY_FINGERPRINT --archive-dir $FOLDER_CACHE $FOLDER_WORKING file://$FOLDER_BACKUP
  else # INCREMENTAL BACKUP
   echo "[ INFO]: INCREMENTAL backup"
   duplicity incr --encrypt-key $KEY_FINGERPRINT --archive-dir $FOLDER_CACHE $FOLDER_WORKING file://$FOLDER_BACKUP
  fi
 fi
fi
