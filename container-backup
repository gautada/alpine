#!/bin/sh
set -xe

USER=$(awk -F':' -v uid=1001 '$3 == uid { print $1 }' /etc/passwd)
BACKUP="/tmp/backup"
CACHE="$BACKUP/cache"
/bin/mkdir -p $CACHE

/bin/chown 1001:1001 $CACHE
cd $CACHE

/bin/su 1001 -c ". /etc/container/backup ; container_backup"
ARCHIVE="$BACKUP/$(/bin/date +'%Y%m%d-%H%M%S')-$(echo $HOSTNAME).tgz"
/bin/tar  --create --gzip --file=$ARCHIVE --verbose ./*

if [ ! -f /mnt/volumes/backup/.archive ] ; then
 /bin/touch /mnt/volumes/backup/.backup
 /bin/mv -v $ARCHIVE /mnt/volumes/backup/
else
 echo "[BACKUP] Unable to run because archive is active"
fi
/bin/rm -f /mnt/volumes/backup/.backup
/bin/rm -rf $BACKUP

# Make the temporary directory for making the backup
# TEMP="$(/bin/mktemp --directory $BACKUP/XXXXX)"
# /bin/mkdir -p $TEMP
# Make sure the temporary directory is owned by the default user
# Change to the temporary directory
# cd $TEMP

# Execute the container_backup function (should dump all files to be backed up in
# the temporary directory
# if [ -f /mnt/volumes/backup/.backup ] ; then
#  echo "Backup lock is active"
# fi

# Push out the tarball to the backup NFS location


