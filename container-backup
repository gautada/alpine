#!/bin/sh

FOLDER_BACKUP="/opt/backup"
FOLDER_WORKING="$FOLDER_BACKUP/.cache"
FOLDER_DAILY="$FOLDER_WORKING/daily"
FOLDER_HOURLY="$FOLDER_WORKING/hourly"
FOLDER_BACKUPS="$FOLDER_BACKUP/points"
FILE_DAILY="$FOLDER_BACKUPS/daily-container-backup.tar.bz2"
BACKUP_TAG="$(date +%H)"
FILE_HOURLY="$FOLDER_BACKUPS/$BACKUP_TAG-container-backup.tar.bz2"
container_backup() {
 pwd
 echo "[ WARN] This function should be overloaded by the container"
 date > alpine-backup.txt
 FOLDER=$(date +%s)
 mkdir $FOLDER
 date > $FOLDER/another-backup.txt
}

container_backup_control() {
 FOLDER_TARGET=$FOLDER_WORKING/$1
 if [ ! -d $FOLDER_TARGET ] ; then
  echo "[DEBUG] Working folder($FOLDER_TARGET) does not exist."
  mkdir -p $FOLDER_TARGET
 else
  rm -rf $FOLDER_TARGET/* $FOLDER_TARGET/.*.sha256
 fi
 cd $FOLDER_TARGET
 container_backup

 sha256sum $(find . -type f) > files.sha256
 SUM="$(sha256sum files.sha256 | head -c 64)"
 mv files.sha256 ".$(echo $SUM).sha256"
}

container_backup_daily() {
 ORIGINAL="$(pwd)"
 echo "[DEBUG] Updating the daily backup point"
 container_backup_control "daily"
 tar -cjf $FILE_DAILY ./
 cd $ORIGINAL
}

container_backup_hourly() {
 ORIGINAL="$(pwd)"
 echo "[DEBUG] Updating the hourly backup point"
 container_backup_control "hourly"
 tar -cjf $FILE_HOURLY ./
 cd $ORIGINAL
}

if [ -z $1 ] ; then
 if [ ! -f $FILE_DAILY ] ; then
  container_backup_daily
 else
  echo "$FILE_DAILY"
  # if timestamp > 24hours - daily 
 fi
else
 if [ "daily" == "$1" ] ; then
  container_backup_daily
 fi
fi

container_backup_hourly
